---
import type { CollectionEntry } from 'astro:content';
import Badge from '@/components/ui/Badge.astro';
import { getOgImage, hasValidCoverImage } from '@/lib/og-pattern';
import { calculateReadingTime } from '@/lib/utils';
import { useTranslations, type Locale } from '@/lib/i18n/translations';
import { getLocaleFromUrl } from '@/lib/i18n/utils';

interface Props {
  post: CollectionEntry<'blog'>;
  featured?: boolean;
  locale?: Locale;
}

const { post, featured = false, locale } = Astro.props;
const { data, body } = post;

// Determine current locale
const currentLocale: Locale = locale ?? getLocaleFromUrl(Astro.url);
const t = useTranslations(currentLocale);
const baseUrl = currentLocale === 'en' ? '/en' : '';

// Calcola reading time dinamicamente dal contenuto
const readingTime = calculateReadingTime(body);

// Get pillar name from translations
const pillarName = t.pillars[data.pillar as keyof typeof t.pillars]?.name || data.pillar;

// Normalize slug (remove .en suffix for URL)
const normalizedSlug = post.slug.replace(/\.en$/, '');

// Immagine: usa coverImage se esiste, altrimenti pattern generato
const displayImage = getOgImage(data.coverImage, post.slug);
const hasCover = hasValidCoverImage(data.coverImage);
---

<a
  href={`${baseUrl}/blog/${normalizedSlug}/`}
  class:list={[
    /* M3 Shape & Elevation Hierarchy:
     * STANDARD CARDS:
     * - Shape: shape-lg (16px) - Standard card rounding
     * - Elevation: Level 1 (Z=1dp) → bg-surface-container-low + elevation-1
     * - Hover: Level 2 (Z=3dp) → elevation-2
     *
     * FEATURED CARDS:
     * - Shape: shape-xl (28px) - Extra large for visual prominence
     * - Elevation: Level 2 (Z=3dp) → bg-surface-container + elevation-2
     * - Hover: Level 3 (Z=6dp) → elevation-3
     */
    'group relative overflow-hidden card-state',
    featured
      ? 'shape-xl bg-surface-container elevation-2 hover:elevation-3 md:grid md:grid-cols-2'
      : 'shape-lg bg-surface-container-low elevation-1 hover:elevation-2',
  ]}
>
  <!-- Image Container -->
  <div
    class:list={[
      'relative overflow-hidden',
      featured ? 'h-64 md:h-full' : 'h-48',
    ]}
  >
    <img
      src={displayImage}
      alt={data.title}
      class:list={[
        "w-full h-full transition-transform duration-500 group-hover:scale-105",
        hasCover ? "object-cover" : "object-contain bg-surface-container"
      ]}
    />
    <!-- Pillar Badge - Level 1 elevation, M3 Spacing: top/left-4 (16dp), gap-2 (8dp) -->
    <div class="absolute top-4 left-4 flex gap-2">
      <Badge variant="secondary" class="backdrop-blur elevation-1">
        {pillarName}
      </Badge>
      {data.featured && (
        <Badge variant="tertiary" class="backdrop-blur elevation-1">
          Featured
        </Badge>
      )}
    </div>
  </div>

  <!-- Content Container - M3 Spacing: 16dp standard padding (spacing-4) -->
  <div class="p-4 flex flex-col justify-between">
    <div>
      <!-- Metadata - M3 Spacing: gap-2 (8dp), mb-3 (12dp spacing-3) -->
      <div class="flex items-center gap-2 text-sm text-on-surface-variant mb-3 opacity-80">
        <span>{data.publishedAt}</span>
        <span>•</span>
        <span class="flex items-center gap-1">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          {readingTime}
        </span>
      </div>

      <!-- Title -->
      <h3
        class:list={[
          'font-bold mb-3 text-on-surface',
          featured ? 'text-2xl md:text-3xl' : 'text-xl',
        ]}
      >
        {data.title}
      </h3>

      <!-- Summary -->
      <p class="text-on-surface-variant line-clamp-3 mb-6 leading-relaxed">
        {data.summary}
      </p>
    </div>

    <!-- Footer: Metadata + CTA -->
    <div class="flex items-center justify-between mt-auto">
      <div class="flex items-center gap-2 text-sm text-on-surface-variant">
        <span>{data.publishedAt}</span>
        <span>•</span>
        <span class="flex items-center gap-1">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          {readingTime}
        </span>
      </div>
      <span
        class="w-10 h-10 flex items-center justify-center shape-full bg-primary-container text-on-primary-container group-hover:bg-primary group-hover:text-on-primary transition-all duration-300 elevation-0 group-hover:elevation-1"
        aria-label="Read article"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M5 12h14"></path>
          <path d="m12 5 7 7-7 7"></path>
        </svg>
      </span>
    </div>
  </div>
</a>
