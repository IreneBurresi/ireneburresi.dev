---
/**
 * Componente SEO completo per <head>
 * Include: meta, canonical, OG, Twitter, robots, feeds, licensing, JSON-LD
 */
import { SITE } from '@/consts/site';
import { canonicalFromPath, toAbsoluteUrl } from '@/lib/seo/url';

export type RobotsPolicy = {
  index?: boolean;
  follow?: boolean;
  maxSnippet?: number;
  maxImagePreview?: 'none' | 'standard' | 'large';
  maxVideoPreview?: number;
};

export interface Props {
  title: string;
  description?: string;
  canonical?: string;

  // SEO Advanced
  metaTitle?: string; // Override for <title> tag, defaults to title
  focusKeyword?: string; // Primary focus keyword for SEO

  // Preview
  ogType?: 'website' | 'article';
  ogImage?: string;

  // OG/Twitter customization
  ogCustom?: {
    title?: string;
    description?: string;
    image?: string;
    imageAlt?: string;
  };
  twitterCustom?: {
    title?: string;
    description?: string;
    image?: string;
    imageAlt?: string;
  };

  // Navigation
  prevUrl?: string; // Previous page URL (for pagination/series)
  nextUrl?: string; // Next page URL (for pagination/series)
  preconnect?: string[]; // Domains to preconnect for performance

  // Article metadata
  publishedTime?: string;
  modifiedTime?: string;
  tags?: string[];
  section?: string;

  // Controlli
  robots?: RobotsPolicy;

  // JSON-LD
  jsonLd?: unknown | unknown[];

  // Feed alternativo per pillar/sezioni
  alternateRss?: { title: string; href: string };

  // i18n
  locale?: 'it' | 'en';
  alternateUrls?: Array<{ locale: 'it' | 'en'; url: string }>;
}

const props = Astro.props;
const site = Astro.site;
if (!site) throw new Error('Astro.site mancante: configura `site` in astro.config.mjs');

// SEO fields with fallbacks
const metaTitle = props.metaTitle ?? props.title;
const description = props.description ?? SITE.description;

const canonicalUrl = props.canonical
  ? toAbsoluteUrl(props.canonical, site)
  : canonicalFromPath(Astro.url.pathname, site);

const ogType = props.ogType ?? 'website';
const ogImageUrl = toAbsoluteUrl(props.ogImage ?? SITE.og.defaultImagePath, site);

// OG customization with cascading fallbacks
const ogTitle = props.ogCustom?.title ?? metaTitle;
const ogDescription = props.ogCustom?.description ?? description;
const ogImage = props.ogCustom?.image
  ? toAbsoluteUrl(props.ogCustom.image, site)
  : ogImageUrl;
const ogImageAlt = props.ogCustom?.imageAlt ?? props.title;

// Twitter customization with fallbacks to OG then defaults
const twitterTitle = props.twitterCustom?.title ?? props.ogCustom?.title ?? metaTitle;
const twitterDescription = props.twitterCustom?.description ?? props.ogCustom?.description ?? description;
const twitterImage = props.twitterCustom?.image
  ? toAbsoluteUrl(props.twitterCustom.image, site)
  : props.ogCustom?.image
  ? toAbsoluteUrl(props.ogCustom.image, site)
  : ogImageUrl;
const twitterImageAlt = props.twitterCustom?.imageAlt ?? props.ogCustom?.imageAlt ?? props.title;

// Robots policy per massima visibilita in SERP
const robots: RobotsPolicy = {
  index: true,
  follow: true,
  maxSnippet: -1,
  maxImagePreview: 'large',
  maxVideoPreview: -1,
  ...props.robots,
};

const robotsContent = [
  robots.index ? 'index' : 'noindex',
  robots.follow ? 'follow' : 'nofollow',
  robots.maxSnippet !== undefined ? `max-snippet:${robots.maxSnippet}` : null,
  robots.maxImagePreview ? `max-image-preview:${robots.maxImagePreview}` : null,
  robots.maxVideoPreview !== undefined ? `max-video-preview:${robots.maxVideoPreview}` : null,
]
  .filter(Boolean)
  .join(',');

const jsonLdPayload = props.jsonLd
  ? Array.isArray(props.jsonLd)
    ? props.jsonLd
    : [props.jsonLd]
  : [];
---

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>{metaTitle}</title>
<meta name="description" content={description} />
{props.focusKeyword && <meta name="keywords" content={props.focusKeyword} />}
<link rel="canonical" href={canonicalUrl.toString()} />

<!-- Resource hints for performance -->
{props.preconnect?.map((domain) => (
  <>
    <link rel="preconnect" href={domain} />
    <link rel="dns-prefetch" href={domain} />
  </>
))}

<!-- Pagination links -->
{props.prevUrl && <link rel="prev" href={toAbsoluteUrl(props.prevUrl, site).toString()} />}
{props.nextUrl && <link rel="next" href={toAbsoluteUrl(props.nextUrl, site).toString()} />}

<!-- hreflang tags for multilingual SEO -->
{props.alternateUrls?.map(({ locale, url }) => (
  <link
    rel="alternate"
    hreflang={locale === 'en' ? 'en' : 'it'}
    href={toAbsoluteUrl(url, site).toString()}
  />
))}
{props.alternateUrls && props.alternateUrls.length > 0 && (
  <link
    rel="alternate"
    hreflang="x-default"
    href={toAbsoluteUrl(props.alternateUrls.find(u => u.locale === 'it')?.url ?? '/', site).toString()}
  />
)}

<!-- Robots: massima visibilita -->
<meta name="robots" content={robotsContent} />
<meta name="googlebot" content={robotsContent} />

<!-- Feeds autodiscovery -->
<link
  rel="alternate"
  type="application/rss+xml"
  title={`${SITE.name} RSS`}
  href={new URL(SITE.feeds.rssPath, site).toString()}
/>
<link
  rel="alternate"
  type="application/atom+xml"
  title={`${SITE.name} Atom`}
  href={new URL(SITE.feeds.atomPath, site).toString()}
/>
<link
  rel="alternate"
  type="application/feed+json"
  title={`${SITE.name} JSON Feed`}
  href={new URL(SITE.feeds.jsonFeedPath, site).toString()}
/>
{props.alternateRss && (
  <link
    rel="alternate"
    type="application/rss+xml"
    title={props.alternateRss.title}
    href={new URL(props.alternateRss.href, site).toString()}
  />
)}

<!-- Licensing -->
<link rel="license" href={SITE.license.humanUrl} />
<link rel="license" type="application/rsl+xml" href={SITE.license.rslUrl} />

<!-- OpenSearch -->
<link
  rel="search"
  type="application/opensearchdescription+xml"
  title={`Cerca su ${SITE.name}`}
  href={new URL('/opensearch.xml', site).toString()}
/>

<!-- Identity -->
<link rel="author" href={SITE.author.url} />
{SITE.author.sameAs?.map((u) => <link rel="me" href={u} />)}

<!-- OpenGraph -->
<meta property="og:type" content={ogType} />
<meta property="og:site_name" content={SITE.name} />
<meta property="og:title" content={ogTitle} />
<meta property="og:description" content={ogDescription} />
<meta property="og:url" content={canonicalUrl.toString()} />
<meta property="og:image" content={ogImage.toString()} />
<meta property="og:image:alt" content={ogImageAlt} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:image:type" content="image/png" />
<meta property="og:locale" content={(props.locale === 'en' ? 'en_US' : SITE.locale).replace('-', '_')} />
{props.locale === 'it' && <meta property="og:locale:alternate" content="en_US" />}
{props.locale === 'en' && <meta property="og:locale:alternate" content="it_IT" />}

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image" />
{SITE.social.twitter && <meta name="twitter:site" content={SITE.social.twitter} />}
<meta name="twitter:title" content={twitterTitle} />
<meta name="twitter:description" content={twitterDescription} />
<meta name="twitter:image" content={twitterImage.toString()} />
<meta name="twitter:image:alt" content={twitterImageAlt} />

<!-- Article extras (per og:type article) -->
{props.publishedTime && <meta property="article:published_time" content={props.publishedTime} />}
{props.modifiedTime && <meta property="article:modified_time" content={props.modifiedTime} />}
{props.section && <meta property="article:section" content={props.section} />}
{props.tags?.map((t) => <meta property="article:tag" content={t} />)}

<!-- JSON-LD Structured Data -->
{jsonLdPayload.map((obj) => (
  <script type="application/ld+json" set:html={JSON.stringify(obj)} />
))}
