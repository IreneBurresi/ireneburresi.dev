---
import { ViewTransitions } from 'astro:transitions';
import Analytics from '@vercel/analytics/astro';
import BaseHead from '@/components/seo/BaseHead.astro';
import type { RobotsPolicy } from '@/components/seo/BaseHead.astro';
import Footer from '@/components/layout/Footer.astro';
import SearchModal from '@/components/search/SearchModal';
import { SITE } from '@/consts/site';
import { buildSiteGraph } from '@/lib/seo/structuredData';
import { getLocaleFromUrl } from '@/lib/i18n/utils';
import type { Locale } from '@/lib/i18n/translations';
import '@/styles/global.css';
import '@/styles/typography.css';
import '@/styles/material.css';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  type?: 'website' | 'article';
  canonical?: string;
  robots?: RobotsPolicy;
  jsonLd?: unknown | unknown[];
  // Article specifics
  publishedTime?: string;
  modifiedTime?: string;
  tags?: string[];
  section?: string;
  // Feed alternativo per pillar
  alternateRss?: { title: string; href: string };
  // i18n
  locale?: Locale;
  alternateUrls?: Array<{ locale: Locale; url: string }>;
}

const {
  title = SITE.name,
  description = SITE.description,
  image,
  type = 'website',
  canonical,
  robots,
  jsonLd,
  publishedTime,
  modifiedTime,
  tags,
  section,
  alternateRss,
  locale,
  alternateUrls,
} = Astro.props;

// Determine current locale from props or URL
const currentLocale: Locale = locale ?? getLocaleFromUrl(Astro.url);

const fullTitle = title === SITE.name ? title : `${title} | ${SITE.name}`;

// HTML lang attribute
const htmlLang = currentLocale === 'en' ? 'en' : SITE.lang;

// JSON-LD: usa quello passato o il default del sito
const structuredData = jsonLd ?? buildSiteGraph();
---

<!doctype html>
<html lang={htmlLang}>
  <head>
    <BaseHead
      title={fullTitle}
      description={description}
      canonical={canonical}
      ogType={type}
      ogImage={image}
      robots={robots}
      jsonLd={structuredData}
      publishedTime={publishedTime}
      modifiedTime={modifiedTime}
      tags={tags}
      section={section}
      alternateRss={alternateRss}
      locale={currentLocale}
      alternateUrls={alternateUrls}
    />

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <!-- Fonts: Self-hosted Roboto Flex variable font loaded via global.css -->

    <!-- Theme initialization (prevent FOUC) -->
    <script is:inline>
      const theme = localStorage.getItem('theme') || 'light';
      document.documentElement.classList.toggle('dark', theme === 'dark');
    </script>

    <Analytics />
    <ViewTransitions />
  </head>
  <body>
    <main class="min-h-screen">
      <slot />
    </main>
    <Footer locale={currentLocale} />
    <SearchModal client:load />
  </body>
</html>
