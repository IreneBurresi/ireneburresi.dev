---
import { getCollection } from 'astro:content';
import PillarLayout from '@/layouts/PillarLayout.astro';
import { PILLARS } from '@/lib/constants';

export async function getStaticPaths() {
  const pillarData = PILLARS.research;

  return Object.values(pillarData.subsections).map((subsection) => ({
    params: { subsection: subsection.slug },
  }));
}

const { subsection } = Astro.params;
const pillarData = PILLARS.research;

const subsectionData = Object.values(pillarData.subsections).find(
  (s) => s.slug === subsection
);

const allPosts = await getCollection('blog', ({ data }) =>
  !data.draft && data.pillar === 'research' && data.subsection === subsection
);

const sortedPosts = allPosts.sort((a, b) => {
  const dateA = new Date(a.data.publishedAt);
  const dateB = new Date(b.data.publishedAt);
  return dateB.getTime() - dateA.getTime();
});
---

<PillarLayout
  pillarName={pillarData.name}
  pillarSlug={pillarData.slug}
  hero={subsectionData?.subtitle || pillarData.hero}
  subsections={pillarData.subsections}
  posts={sortedPosts}
  currentSubsection={subsection}
/>
